@page
@model FishCalc.Web.Pages.Features.SalaryProcessModel
@using System.Globalization

@{
    ViewData["Title"] = "Phân Bổ Lương";
    var culture = new CultureInfo("vi-VN");
}

<!-- External Libs -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/airbnb.css">

<style>
    /* --- CSS Custom cho Table Logic (Khó thay thế hoàn toàn bằng Tailwind) --- */
    :root {
        --grid-border: #e2e8f0; /* slate-200 */
        --header-bg: #f8fafc;   /* slate-50 */
        --focus-bg: #f0f9ff;    /* sky-50 */
        --focus-border: #0ea5e9; /* sky-500 */
    }

    /* Scrollbar tinh tế */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Cấu trúc bảng */
    .salary-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
    }

    .salary-table th,
    .salary-table td {
        border-right: 1px solid var(--grid-border);
        border-bottom: 1px solid var(--grid-border);
    }
    
    /* Bỏ border bên phải của cột cuối cùng để giao diện liền mạch */
    .salary-table th:last-child,
    .salary-table td:last-child {
        border-right: none;
    }
    
    /* Sticky Headers & Columns */
    .salary-table thead th {
        position: sticky;
        top: 0;
        z-index: 30;
        background: var(--header-bg);
    }

    .salary-table tbody td:first-child,
    .salary-table tfoot td:first-child,
    .salary-table thead th:first-child {
        position: sticky;
        left: 0;
        z-index: 40; /* Cao hơn header thường */
        background: white;
        border-right: 2px solid var(--grid-border); /* Border đậm ngăn cách cột cố định */
    }
    
    .salary-table thead th:first-child {
        z-index: 50; /* Góc trên cùng bên trái - cao nhất */
        background: var(--header-bg);
    }

    .salary-table tfoot td {
        position: sticky;
        bottom: 0;
        z-index: 30;
        background: #f1f5f9; /* slate-100 */
        border-top: 2px solid var(--grid-border);
        font-weight: 700;
    }
    
    .salary-table tfoot td:first-child {
        z-index: 50;
    }

    /* Input Styling - Excel like */
    .cell-input {
        width: 100%;
        height: 100%;
        padding: 12px 16px;
        border: 2px solid transparent;
        background: transparent;
        text-align: right;
        font-variant-numeric: tabular-nums;
        transition: all 0.15s ease;
        outline: none;
    }

    .cell-input:focus {
        background: white;
        border-color: var(--focus-border);
        box-shadow: inset 0 2px 4px 0 rgb(0 0 0 / 0.05);
        z-index: 10;
        position: relative;
    }

    /* Highlight Active Row/Col */
    .row-active td { background-color: #f8fafc; }
    .col-active { background-color: #f8fafc !important; }
    .row-active td.col-active { background-color: var(--focus-bg) !important; }

    /* Sub-total Hint */
    .sub-total-hint {
        position: absolute;
        bottom: 2px;
        left: 4px; /* Chuyển qua trái cho dễ nhìn */
        font-size: 0.65rem;
        color: #0ea5e9;
        font-weight: 600;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .cell-wrapper:focus-within .sub-total-hint,
    .sub-total-hint.has-value { opacity: 1; }
</style>

<div class="min-h-screen bg-slate-50 pb-20 font-sans text-slate-800">
    <form method="post" asp-page-handler="ProcessData" class="flex flex-col h-full max-w-[1400px] mx-auto p-4 md:p-6">
        
        <!-- Header Section -->
        <div
            class="grid grid-cols-1 md:grid-cols-3 items-center mb-4 bg-white p-4 rounded-2xl border border-slate-100 shadow-sm gap-4">

            <div class="text-left">
                <h2 class="text-xl font-bold text-slate-800 tracking-tight">Bảng Tính Lương</h2>
                <p class="text-red-500 text-xs mt-1">
                    *lưu ý nhập đúng ngày tính lương để tránh trùng lặp dữ liệu
                </p>
            </div>

            <div class="flex justify-center">
                <div
                    class="flex flex-col items-center bg-slate-50 px-6 py-2 rounded-xl border border-slate-200 shadow-sm">
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Ngày tính
                        toán</label>
                    <input asp-for="ProcessDate"
                        class="date-picker bg-transparent font-bold text-lg text-slate-700 text-center outline-none w-32 cursor-pointer hover:text-sky-600 transition-colors" />
                </div>
            </div>

            <div class="hidden md:block text-right">
            </div>
        </div>

        @if (!ModelState.IsValid)
        {
            <div class="mb-6 p-4 rounded-xl bg-red-50 border border-red-200 flex items-start gap-3 animate-pulse">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600 mt-0.5"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
                <div class="text-sm text-red-800">
                    <h3 class="font-bold mb-1">Vui lòng kiểm tra lại:</h3>
                    <div asp-validation-summary="All" class="list-disc list-inside"></div>
                </div>
            </div>
        }

        <!-- Main Content Area: Grid -->
        <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden flex flex-col mb-6">
            <!-- Table Wrapper -->
            <!-- max-h-[65vh] để đảm bảo scroll trên màn hình nhỏ nhưng không quá dài trên màn to -->
<div class="overflow-x-auto custom-scrollbar w-full bg-white relative">                <table class="salary-table w-full text-left">
                    <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-semibold tracking-wider">
                        <tr>
                            <th class="py-3 px-4 min-w-[220px]">
                                Loại Cá / Tổ
                            </th>
                            @foreach (var u in Model.SelectedProcessingUnits)
                            {
                                <th data-col-idx="@u.UnitId" class="py-3 px-2 min-w-[120px] text-center">
                                    <div class="flex flex-col items-center">
                                        <span class="text-slate-700 font-bold">@u.UnitName</span>
                                    </div>
                                </th>
                            }
                        </tr>
                    </thead>

                    <tbody class="divide-y divide-slate-100 text-sm text-slate-700">
                        @foreach (var fish in Model.SelectedFishTypes)
                        {
                            <tr class="group hover:bg-slate-50 transition-colors">
                                <!-- Cột Loại cá Sticky -->
                                <td class="py-3 px-4 align-middle group-hover:bg-slate-50">
                                    <div class="flex flex-col">
                                        <span class="font-bold text-slate-700 text-sm">@fish.Name</span>
                                        <span class="font-mono text-xs text-blue-600 bg-blue-50 w-fit px-1.5 py-0.5 rounded mt-1">
                                            @fish.PricePerUnit.ToString("#,##0", culture).000₫
                                        </span>
                                    </div>
                                </td>

                                <!-- Các cột Input -->
                                @foreach (var u in Model.SelectedProcessingUnits)
                                {
                                    <td data-col-idx="@u.UnitId" class="p-0 relative h-14">
                                        <div class="cell-wrapper w-full h-full relative">
                                            <input type="text" inputmode="decimal" 
                                                   name="Data[@u.UnitId][@fish.Id]"
                                                   class="cell-input js-calc-trigger placeholder:text-slate-200"
                                                   data-price="@fish.PricePerUnit"
                                                   data-unit-id="@u.UnitId" 
                                                   placeholder="-" 
                                                   autocomplete="off" 
                                                   value="@(Model.Data.ContainsKey(u.UnitId) && Model.Data[u.UnitId].ContainsKey(fish.Id) ? Model.Data[u.UnitId][fish.Id]?.ToString() : "")" />
                                            <div class="sub-total-hint font-mono"></div>
                                        </div>
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>

                    <!-- Footer Tổng -->
                    <tfoot class="bg-slate-100 text-slate-700 text-sm font-bold">
                        <tr>
                            <td class="py-4 px-4 text-right uppercase text-xs tracking-wider text-slate-500">
                                Tổng Sản Lượng (Kg)
                            </td>
                            @foreach (var u in Model.SelectedProcessingUnits)
                            {
                                <td data-col-idx="@u.UnitId" class="py-3 px-4 text-right">
                                    <span id="total-unit-@u.UnitId" class="unit-total-display block font-mono text-blue-600">0</span>
                                </td>
                            }
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Footer Control Bar -->
        <div
            class="mt-4 sticky w-[calc(90vw-3rem)] grid grid-cols-1 md:grid-cols-3 items-center bg-slate-800 text-white p-4 rounded-xl shadow-lg gap-4">

            <div class="hidden md:block text-left text-xs text-slate-400 space-y-1">
                <p>💡 <span class="font-semibold text-slate-300">Enter</span> để xuống dòng</p>
                <p>💡 <span class="font-semibold text-slate-300">Phím mũi tên</span> để di chuyển</p>
            </div>

            <div class="flex flex-col items-center justify-center">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Tổng chi phí chi trả</p>
                <div class="relative">
                    <p id="grand-total" class="text-4xl font-mono font-bold text-sky-400 mt-1 drop-shadow-md">0 ₫</p>
                    <div class="absolute -inset-4 bg-sky-500/10 blur-xl rounded-full -z-10"></div>
                </div>
            </div>

            <div class="flex justify-center md:justify-end">
                <button type="submit"
                    class="bg-sky-500 hover:bg-sky-400 text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-sky-500/30 transition-all transform active:scale-95 flex items-center gap-2">
                    LƯU
                </button>
            </div>

        </div>
        <div class="mt-4">
            <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 ml-1">
                Ghi chú...
            </label>

            <div class="relative group">
                <div
                    class="absolute top-3 left-3 text-slate-400 group-focus-within:text-sky-500 transition-colors pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </div>

                <textarea asp-for="NoteOption" class="w-full h-24 p-3 pl-10 rounded-xl
                         bg-slate-50 border border-slate-200 
                         text-slate-700 text-sm font-medium
                         placeholder:text-slate-400 placeholder:font-normal
                         shadow-sm resize-none
                         focus:bg-white focus:border-sky-500 focus:ring-4 focus:ring-sky-500/10 
                         outline-none transition-all duration-200 ease-in-out"
                    placeholder="Nhập ghi chú chi tiết cho bảng tính này (nếu có)..."></textarea>
            </div>
        </div>

    </form>
</div>

<!-- Modal Confirm -->
<div id="confirm-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-sm border border-slate-100">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-50 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-base font-semibold leading-6 text-slate-900" id="modal-title">Lưu Bảng Lương?</h3>
                            <div class="mt-2">
                                <p class="text-sm text-slate-500">Dữ liệu tính lương cho ngày:</p>
                                <div class="mt-2 bg-slate-50 rounded-lg p-3 text-center border border-slate-100">
                                    <span class="text-xl font-bold text-blue-600" id="modal-date-display">...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-2">
                    <button type="button" id="btn-confirm-save" class="inline-flex w-full justify-center rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:w-auto transition-colors">Đồng ý</button>
                    <button type="button" id="btn-cancel-save" class="mt-3 inline-flex w-full justify-center rounded-lg bg-white px-3 py-2 text-sm font-semibold text-slate-700 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto transition-colors">Hủy</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/vn.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Khởi tạo biến
            const form = document.querySelector('form');
            const table = document.querySelector('.salary-table');
            const inputs = document.querySelectorAll('.js-calc-trigger');
            const grandTotalEl = document.getElementById('grand-total');
            const unitTotalNodes = new Map();
            const moneyFormatter = new Intl.NumberFormat('vi-VN');
            const unitSumMap = new Map();
            let grandTotal = 0;

            // Elements cho Modal
            const saveBtn = document.querySelector('button[type="submit"]'); 
            const modal = document.getElementById('confirm-modal');
            const btnConfirm = document.getElementById('btn-confirm-save');
            const btnCancel = document.getElementById('btn-cancel-save');
            const modalDateDisplay = document.getElementById('modal-date-display');

            // --- 1. SETUP DATE PICKER ---
            const datePickerInput = document.querySelector('.date-picker');
            const fpInstance = flatpickr(datePickerInput, {
                locale: 'vn',
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'd/m/Y', 
                defaultDate: '@Model.ProcessDate.ToString("yyyy-MM-dd")',
                onChange: function(selectedDates, dateStr, instance) {
                    const url = new URL(window.location.href);
                    url.searchParams.set("ProcessDate", dateStr);
                    window.location.href = url.toString();
                }
            });

            // --- 2. MODAL LOGIC ---
            saveBtn.addEventListener('click', (e) => {
                e.preventDefault(); 
                let dateStr = "Chưa chọn ngày";
                if (fpInstance.selectedDates.length > 0) {
                    dateStr = fpInstance.formatDate(fpInstance.selectedDates[0], "d/m/Y");
                }
                modalDateDisplay.textContent = dateStr;
                modal.classList.remove('hidden'); 
            });

            btnCancel.addEventListener('click', () => {
                modal.classList.add('hidden'); 
            });

            btnConfirm.addEventListener('click', () => {
                btnConfirm.textContent = "Đang xử lý...";
                btnConfirm.disabled = true;
                btnConfirm.classList.add('opacity-75', 'cursor-not-allowed');
                form.submit();
            });

            // Close modal on click outside
            modal.addEventListener('click', (e) => {
                if (e.target.classList.contains('bg-slate-900/40')) {
                    modal.classList.add('hidden');
                }
            });

            // --- 3. CALCULATION LOGIC ---
            // Cache total display nodes
            document.querySelectorAll('.unit-total-display').forEach(el => {
                unitTotalNodes.set(el.id.replace('total-unit-', ''), el);
            });

            // Initial Calc
            inputs.forEach(input => {
                const uid = input.dataset.unitId;
                if (!unitSumMap.has(uid)) unitSumMap.set(uid, 0);
                if (input.value && input.value != "0") {
                    calculateRow(input);
                }
            });

            function calculateRow(input) {
                const qty = parseFloat(input.value) || 0;
                const price = parseFloat(input.dataset.price) || 0;
                const total = qty * price;
                const unitId = input.dataset.unitId;

                // Show sub-total hint inside cell
                const hintEl = input.nextElementSibling;
                if (total > 0) {
                    hintEl.textContent = moneyFormatter.format(total);
                    hintEl.classList.add('has-value');
                } else {
                    hintEl.textContent = '';
                    hintEl.classList.remove('has-value');
                }
                
                recalcUnitTotal(unitId);
            }

            function recalcUnitTotal(unitId) {
                let sum = 0;
                const unitInputs = document.querySelectorAll(`.js-calc-trigger[data-unit-id="${unitId}"]`);
                unitInputs.forEach(inp => {
                    const q = parseFloat(inp.value) || 0;
                    const p = parseFloat(inp.dataset.price) || 0;
                    sum += (q * p);
                });
                
                unitSumMap.set(unitId, sum);
                const node = unitTotalNodes.get(unitId);
                if (node) {
                    node.textContent = moneyFormatter.format(sum);
                }
                recalcGrandTotal();
            }

            function recalcGrandTotal() {
                grandTotal = 0;
                unitSumMap.forEach(val => grandTotal += val);
                grandTotalEl.textContent = moneyFormatter.format(grandTotal) + '.000₫';
            }

            // --- 4. EXCEL NAVIGATION & EVENTS ---
            table.addEventListener('input', e => {
                if (e.target.classList.contains('js-calc-trigger')) {
                    calculateRow(e.target);
                }
            });

            // Highlight Active
            table.addEventListener('focusin', e => {
                if (!e.target.classList.contains('js-calc-trigger')) return;
                
                // Clear old actives
                document.querySelectorAll('.row-active, .col-active').forEach(el => {
                    el.classList.remove('row-active', 'col-active');
                });

                const td = e.target.closest('td');
                const tr = e.target.closest('tr');
                const colId = td.dataset.colIdx;

                if (tr) tr.classList.add('row-active');
                if (colId) {
                    table.querySelectorAll(`td[data-col-idx="${colId}"], th[data-col-idx="${colId}"]`)
                        .forEach(c => c.classList.add('col-active'));
                }
                e.target.select();
            });

            // Keyboard Nav
            table.addEventListener('keydown', e => {
                if (!e.target.classList.contains('js-calc-trigger')) return;
                const key = e.key;
                const allowedKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter'];
                if (!allowedKeys.includes(key)) return;
                
                if (key !== 'Enter') e.preventDefault(); // Allow Enter to submit if default, but usually we move down
                if (key === 'Enter') e.preventDefault();

                const currentInput = e.target;
                const currentTd = currentInput.closest('td');
                const currentRow = currentTd.closest('tr');
                const currentIndexInRow = Array.from(currentRow.children).indexOf(currentTd);
                
                let nextInput = null;

                if (key === 'ArrowRight') {
                    const nextTd = currentRow.children[currentIndexInRow + 1];
                    if (nextTd) nextInput = nextTd.querySelector('input');
                } else if (key === 'ArrowLeft') {
                    const prevTd = currentRow.children[currentIndexInRow - 1];
                    if (prevTd) nextInput = prevTd.querySelector('input');
                } else if (key === 'ArrowDown' || key === 'Enter') {
                    const nextRow = currentRow.nextElementSibling;
                    if (nextRow) {
                        const targetTd = nextRow.children[currentIndexInRow];
                        if (targetTd) nextInput = targetTd.querySelector('input');
                    }
                } else if (key === 'ArrowUp') {
                    const prevRow = currentRow.previousElementSibling;
                    if (prevRow) {
                        const targetTd = prevRow.children[currentIndexInRow];
                        if (targetTd) nextInput = targetTd.querySelector('input');
                    }
                }

                if (nextInput) nextInput.focus();
            });
        });
    </script>
}